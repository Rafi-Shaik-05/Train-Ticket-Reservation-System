<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Train Ticket Reservation System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .train-card { transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out; }
        .train-card:hover { transform: translateY(-5px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        .prose { max-width: none; }
        .prose h3 { margin-bottom: 0.5em; font-size: 1.25em; }
        .prose p { margin-bottom: 0.5em; }
        .prose ul { list-style-position: inside; padding-left: 0; margin-bottom: 1em; }
        .loader { border: 4px solid #f3f3f3; border-radius: 50%; border-top: 4px solid #4f46e5; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

<!-- Auth Container -->
<div id="auth-container" class="min-h-screen flex items-center justify-center">
    <div class="max-w-md w-full bg-white p-8 rounded-lg shadow-md">
        <!-- Login Form -->
        <form id="login-form">
            <h2 class="text-2xl font-bold text-center mb-6">Login</h2>
            <div class="mb-4">
                <label for="login-email" class="block text-sm font-medium text-gray-700">Email</label>
                <input type="email" id="login-email" required class="mt-1 block w-full py-2 px-3 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
            </div>
            <div class="mb-6">
                <label for="login-password" class="block text-sm font-medium text-gray-700">Password</label>
                <input type="password" id="login-password" required class="mt-1 block w-full py-2 px-3 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
            </div>
            <button type="submit" class="w-full bg-indigo-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-indigo-700 disabled:opacity-75">Login</button>
            <p class="text-center text-sm text-gray-600 mt-4">
                Don't have an account? <a href="#" id="show-register" class="font-medium text-indigo-600 hover:text-indigo-500">Register</a>
            </p>
        </form>

        <!-- Register Form -->
        <form id="register-form" class="hidden">
            <h2 class="text-2xl font-bold text-center mb-6">Register</h2>
            <div class="mb-4">
                <label for="register-email" class="block text-sm font-medium text-gray-700">Email</label>
                <input type="email" id="register-email" required class="mt-1 block w-full py-2 px-3 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
            </div>
            <div class="mb-6">
                <label for="register-password" class="block text-sm font-medium text-gray-700">Password</label>
                <input type="password" id="register-password" required class="mt-1 block w-full py-2 px-3 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
            </div>
            <button type="submit" class="w-full bg-indigo-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-indigo-700 disabled:opacity-75">Register</button>
            <p class="text-center text-sm text-gray-600 mt-4">
                Already have an account? <a href="#" id="show-login" class="font-medium text-indigo-600 hover:text-indigo-500">Login</a>
            </p>
        </form>
    </div>
</div>

<!-- Main App Container (Initially Hidden) -->
<div id="app-container" class="hidden">
    <div id="app" class="container mx-auto p-4 md:p-8 max-w-6xl">
        <header class="text-center mb-8 relative">
            <h1 class="text-4xl font-bold text-gray-900">Indian Railways Reservation</h1>
            <p class="text-lg text-gray-600 mt-2">Your Journey, Our Priority</p>
            <div class="absolute top-0 right-0 flex items-center">
                <span id="user-email" class="text-sm text-gray-600 mr-4"></span>
                <button id="logout-btn" class="bg-red-500 text-white font-semibold py-2 px-4 rounded-md hover:bg-red-600 text-sm">Logout</button>
            </div>
        </header>

        <main>
            <!-- Search and Booking Section -->
            <div class="bg-white p-6 rounded-lg shadow-md mb-8">
                <h2 class="text-2xl font-semibold mb-4 border-b pb-2">Book Your Ticket</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label for="from" class="block text-sm font-medium text-gray-700">From</label>
                        <select id="from" class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                            <option>New Delhi (NDLS)</option>
                            <option>Mumbai (CST)</option>
                            <option>Kolkata (HWH)</option>
                            <option>Chennai (MAS)</option>
                        </select>
                    </div>
                    <div>
                        <label for="to" class="block text-sm font-medium text-gray-700">To</label>
                        <select id="to" class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                            <option>Mumbai (CST)</option>
                            <option>New Delhi (NDLS)</option>
                            <option>Kolkata (HWH)</option>
                            <option>Chennai (MAS)</option>
                        </select>
                    </div>
                    <div>
                        <label for="date" class="block text-sm font-medium text-gray-700">Date of Journey</label>
                        <input type="date" id="date" class="mt-1 block w-full py-2 px-3 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                    </div>
                </div>
                <div class="text-center mt-6">
                    <button id="search-trains" class="bg-indigo-600 text-white font-semibold py-2 px-6 rounded-md hover:bg-indigo-700">Find Trains</button>
                </div>
            </div>

            <!-- Train List Section -->
            <div id="train-list-container" class="hidden">
                <h3 class="text-xl font-semibold mb-4">Available Trains</h3>
                <div id="train-list" class="space-y-4"></div>
            </div>

            <!-- My Bookings Section -->
            <div class="mt-12">
                <h2 class="text-2xl font-semibold mb-4 border-b pb-2">My Bookings</h2>
                <div id="bookings-list" class="space-y-4">
                    <p id="no-bookings" class="text-gray-500">You have no bookings yet.</p>
                </div>
            </div>
        </main>
    </div>
</div>

<!-- All Modals (Message, Booking, etc.) -->
<div id="message-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white p-8 rounded-lg shadow-xl text-center w-full max-w-sm mx-4">
        <p id="message-text" class="text-lg mb-6"></p>
        <button id="close-message-modal" class="bg-indigo-600 text-white font-semibold py-2 px-6 rounded-md">OK</button>
    </div>
</div>
<div id="booking-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-40">
    <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md mx-4">
        <h3 class="text-2xl font-bold mb-4" id="modal-train-name"></h3>
        <p class="mb-2">From: <span id="modal-from-station"></span></p>
        <p class="mb-4">To: <span id="modal-to-station"></span></p>
        <div class="mb-4">
            <label for="passenger-name" class="block text-sm font-medium text-gray-700">Passenger Name</label>
            <input type="text" id="passenger-name" class="mt-1 block w-full py-2 px-3 border border-gray-300 rounded-md">
        </div>
        <div class="mb-6">
            <label for="passenger-age" class="block text-sm font-medium text-gray-700">Age</label>
            <input type="number" id="passenger-age" class="mt-1 block w-full py-2 px-3 border border-gray-300 rounded-md">
        </div>
        <div class="flex justify-end space-x-4">
            <button id="cancel-booking-modal-btn" class="bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-md">Cancel</button>
            <button id="confirm-booking-btn" class="bg-green-600 text-white font-semibold py-2 px-4 rounded-md">Confirm Booking</button>
        </div>
    </div>
</div>
<div id="cancellation-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-sm mx-4 text-center">
        <h3 class="text-xl font-bold mb-4">Confirm Cancellation</h3>
        <p class="text-gray-700 mb-6">Are you sure you want to cancel this ticket?</p>
        <div class="flex justify-center space-x-4">
            <button id="cancel-cancellation-btn" class="bg-gray-300 text-gray-800 font-semibold py-2 px-6 rounded-md">Go Back</button>
            <button id="confirm-cancellation-btn" class="bg-red-600 text-white font-semibold py-2 px-6 rounded-md">Confirm</button>
        </div>
    </div>
</div>

<script>
    // --- STATE MANAGEMENT ---
    let currentUser = null;
    let selectedTrain = null;
    let bookingToCancelId = null;

    // --- UI ELEMENTS ---
    const authContainer = document.getElementById('auth-container');
    const appContainer = document.getElementById('app-container');
    const loginForm = document.getElementById('login-form');
    const registerForm = document.getElementById('register-form');
    const showRegisterLink = document.getElementById('show-register');
    const showLoginLink = document.getElementById('show-login');
    const userEmailSpan = document.getElementById('user-email');
    const logoutBtn = document.getElementById('logout-btn');

    const messageModal = document.getElementById('message-modal');
    const messageText = document.getElementById('message-text');
    const closeMessageModalBtn = document.getElementById('close-message-modal');

    const searchTrainsBtn = document.getElementById('search-trains');
    const fromSelect = document.getElementById('from');
    const toSelect = document.getElementById('to');
    const dateInput = document.getElementById('date');
    const trainListContainer = document.getElementById('train-list-container');
    const trainListDiv = document.getElementById('train-list');
    const bookingsListDiv = document.getElementById('bookings-list');
    const noBookingsP = document.getElementById('no-bookings');

    const bookingModal = document.getElementById('booking-modal');
    const cancellationModal = document.getElementById('cancellation-modal');

    // --- AUTHENTICATION LOGIC ---

    showRegisterLink.addEventListener('click', (e) => {
        e.preventDefault();
        loginForm.classList.add('hidden');
        registerForm.classList.remove('hidden');
    });

    showLoginLink.addEventListener('click', (e) => {
        e.preventDefault();
        registerForm.classList.add('hidden');
        loginForm.classList.remove('hidden');
    });

    registerForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const email = document.getElementById('register-email').value;
        const password = document.getElementById('register-password').value;
        const button = registerForm.querySelector('button');
        button.disabled = true;
        button.textContent = 'Registering...';

        try {
            const response = await fetch('/api/auth/register', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email, password })
            });

            if (response.ok) {
                const newUser = await response.json();
                showMessage(`Registration successful for ${newUser.email}! You can now log in.`);
                registerForm.reset();
                showLoginLink.click();
            } else {
                const errorMessage = await response.text();
                showMessage(`Registration Failed: ${errorMessage}`);
            }
        } catch (error) {
            showMessage('An error occurred. Please try again.');
        } finally {
            button.disabled = false;
            button.textContent = 'Register';
        }
    });

    loginForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const email = document.getElementById('login-email').value;
        const password = document.getElementById('login-password').value;
        const button = loginForm.querySelector('button');
        button.disabled = true;
        button.textContent = 'Logging in...';

        try {
            const response = await fetch('/api/auth/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email, password })
            });

            if (response.ok) {
                currentUser = await response.json();
                initializeApp();
            } else {
                const errorMessage = await response.text();
                showMessage(`Login Failed: ${errorMessage}`);
            }
        } catch (error) {
            showMessage('An error occurred. Please try again.');
        } finally {
            button.disabled = false;
            button.textContent = 'Login';
        }
    });

    logoutBtn.addEventListener('click', () => {
        currentUser = null;
        authContainer.classList.remove('hidden');
        appContainer.classList.add('hidden');
        loginForm.reset();
        registerForm.reset();
        // We don't need a backend call for logout in this simple session-based setup.
        // Clearing the state and showing the login page is enough.
        // The session cookie will be invalid on the next protected request.
    });

    // --- MAIN APPLICATION LOGIC ---

    function initializeApp() {
        authContainer.classList.add('hidden');
        appContainer.classList.remove('hidden');
        userEmailSpan.textContent = currentUser.email;

        loadUserBookings();
        setDefaultDate();

        searchTrainsBtn.addEventListener('click', handleSearchTrains);
        trainListDiv.addEventListener('click', handleTrainListClick);
        bookingsListDiv.addEventListener('click', handleBookingsListClick);

        document.getElementById('confirm-booking-btn').addEventListener('click', handleConfirmBooking);
        document.getElementById('cancel-booking-modal-btn').addEventListener('click', closeBookingModal);
        document.getElementById('confirm-cancellation-btn').addEventListener('click', handleConfirmCancellation);
        document.getElementById('cancel-cancellation-btn').addEventListener('click', closeCancellationModal);
    }

    async function loadUserBookings() {
        if (!currentUser) return;
        try {
            // Include credentials to ensure the session cookie is sent
            const response = await fetch(`/api/bookings/${currentUser.id}`, { credentials: 'include' });
            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(errorText || 'Failed to fetch bookings.');
            }
            const bookings = await response.json();
            renderBookings(bookings);
        } catch (error) {
            showMessage(`Error loading bookings: ${error.message}`);
        }
    }

    async function handleSearchTrains() {
        const from = fromSelect.value;
        const to = toSelect.value;
        if (!from || !to || !dateInput.value) {
            return showMessage('Please fill out all search fields.');
        }

        try {
            // Include credentials to ensure the session cookie is sent
            const response = await fetch(`/api/trains/search?from=${from}&to=${to}`, { credentials: 'include' });

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(errorText || `Server responded with status: ${response.status}`);
            }

            const trains = await response.json();
            renderTrains(trains);
        } catch (error) {
            showMessage(`Search Failed: ${error.message}`);
            console.error('Search error:', error);
        }
    }

    function handleTrainListClick(e) {
        if (e.target.classList.contains('book-now-btn')) {
            const trainId = e.target.dataset.trainId;
            const trainCard = document.getElementById(`train-card-${trainId}`);
            selectedTrain = {
                id: trainId,
                name: trainCard.dataset.trainName,
                from: trainCard.dataset.fromStation,
                to: trainCard.dataset.toStation
            };
            openBookingModal();
        }
    }

    function handleBookingsListClick(e) {
        if (e.target.classList.contains('cancel-ticket-btn')) {
            bookingToCancelId = e.target.dataset.bookingId;
            openCancellationModal();
        }
    }

    async function handleConfirmBooking() {
        const passengerName = document.getElementById('passenger-name').value;
        const passengerAge = document.getElementById('passenger-age').value;

        if (!passengerName || !passengerAge) {
            return showMessage('Please enter passenger name and age.');
        }

        const payload = {
            userId: currentUser.id,
            trainId: selectedTrain.id,
            passengerName,
            passengerAge: parseInt(passengerAge)
        };

        try {
            const response = await fetch('/api/bookings', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload),
                credentials: 'include' // Include credentials for protected endpoint
            });

            if (!response.ok) {
                const errorMsg = await response.text();
                throw new Error(errorMsg);
            }

            showMessage('Booking successful!');
            closeBookingModal();
            loadUserBookings();
            handleSearchTrains();
        } catch (error) {
            showMessage(`Booking failed: ${error.message}`);
        }
    }

    async function handleConfirmCancellation() {
        if (!bookingToCancelId) return;

        try {
            const response = await fetch(`/api/bookings/${bookingToCancelId}`, {
                method: 'DELETE',
                credentials: 'include' // Include credentials for protected endpoint
            });
            if (!response.ok) {
                const errorMsg = await response.text();
                throw new Error(errorMsg);
            }
            showMessage('Cancellation successful!');
            closeCancellationModal();
            loadUserBookings();
        } catch (error) {
            showMessage(`Cancellation failed: ${error.message}`);
        }
    }

    // --- RENDERING FUNCTIONS ---
    function renderTrains(trains) {
        trainListDiv.innerHTML = '';
        if (trains.length === 0) {
            trainListDiv.innerHTML = '<p class="text-gray-500">No direct trains found for this route.</p>';
        } else {
            trains.forEach(train => {
                const card = document.createElement('div');
                card.id = `train-card-${train.id}`;
                card.className = 'train-card bg-white p-4 rounded-lg shadow-sm border flex justify-between items-center';
                card.dataset.trainName = train.name;
                card.dataset.fromStation = train.fromStation;
                card.dataset.toStation = train.toStation;
                card.innerHTML = `
                    <div>
                        <h4 class="text-lg font-bold text-indigo-700">${train.name} (${train.trainNumber})</h4>
                        <p class="text-sm text-gray-600">${train.fromStation} &rarr; ${train.toStation}</p>
                    </div>
                    <div class="text-right">
                        <p class="font-semibold">Available Seats: <span class="text-green-600 font-bold text-lg">${train.availableSeats}</span> / ${train.totalSeats}</p>
                        <button data-train-id="${train.id}" class="book-now-btn mt-2 bg-indigo-600 text-white font-semibold py-2 px-4 rounded-md ${train.availableSeats <= 0 ? 'opacity-50 cursor-not-allowed' : ''}" ${train.availableSeats <= 0 ? 'disabled' : ''}>
                            Book Now
                        </button>
                    </div>
                `;
                trainListDiv.appendChild(card);
            });
        }
        trainListContainer.classList.remove('hidden');
    }

    function renderBookings(bookings) {
        bookingsListDiv.innerHTML = '';
        if (bookings.length === 0) {
            bookingsListDiv.appendChild(noBookingsP);
            noBookingsP.classList.remove('hidden');
        } else {
            noBookingsP.classList.add('hidden');
            bookings.forEach(booking => {
                const card = document.createElement('div');
                card.className = 'bg-white p-4 rounded-lg shadow-sm border';
                const bookingDate = new Date(booking.bookingDate).toLocaleString();
                card.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <h4 class="text-lg font-bold text-gray-800">${booking.train.name}</h4>
                            <p class="text-sm text-gray-600">${booking.train.fromStation} to ${booking.train.toStation}</p>
                            <p class="text-sm text-gray-500 mt-2">Passenger: ${booking.passengerName}, Age: ${booking.passengerAge}</p>
                        </div>
                        <div class="text-right">
                            <span class="px-3 py-1 text-sm font-semibold rounded-full bg-green-100 text-green-800">${booking.status}</span>
                            <p class="text-xs text-gray-500 mt-2">Booked on: ${bookingDate}</p>
                        </div>
                    </div>
                    <div class="mt-4 pt-4 border-t text-right">
                        <button data-booking-id="${booking.id}" class="cancel-ticket-btn bg-red-100 text-red-700 font-semibold py-2 px-4 rounded-md">Cancel Ticket</button>
                    </div>
                `;
                bookingsListDiv.appendChild(card);
            });
        }
    }

    // --- MODAL FUNCTIONS ---
    function openBookingModal() {
        document.getElementById('modal-train-name').textContent = selectedTrain.name;
        document.getElementById('modal-from-station').textContent = selectedTrain.from;
        document.getElementById('modal-to-station').textContent = selectedTrain.to;
        document.getElementById('passenger-name').value = '';
        document.getElementById('passenger-age').value = '';
        bookingModal.classList.remove('hidden');
    }
    function closeBookingModal() { bookingModal.classList.add('hidden'); }
    function openCancellationModal() { cancellationModal.classList.remove('hidden'); }
    function closeCancellationModal() { cancellationModal.classList.add('hidden'); }

    // --- UTILITY FUNCTIONS ---
    function showMessage(message) {
        messageText.textContent = message;
        messageModal.classList.remove('hidden');
    }
    closeMessageModalBtn.addEventListener('click', () => {
        messageModal.classList.add('hidden');
    });
    function setDefaultDate() {
        const today = new Date();
        const yyyy = today.getFullYear();
        const mm = String(today.getMonth() + 1).padStart(2, '0');
        const dd = String(today.getDate()).padStart(2, '0');
        dateInput.value = `${yyyy}-${mm}-${dd}`;
        dateInput.min = `${yyyy}-${mm}-${dd}`;
    }

</script>

</body>
</html>
